# picks up from /lustre/f1/unswept/Gilbert.P.Compo/20CRV3//NOTES_build.csh_Haswell.txt
#10 Feb 2017


# last try
# Put -xSSE4.2 back in 
# simultaneously: 
#	nwprod/lib/sorc/sigio
#       nwprod/lib/sorc/sfcio
# and build. Maybe just these two libraries need the xSSE4.2 ? 8:41pm MST
# No. GFS did not run 9:14 MST

# Also put back xSSE4.2 in global_sighdr and global_sfchdr
# worked great on Haswell
# testing on Broadwell: 
# worked for 120 cycles!

#11 Feb
# removing xHost everywhere and making sure everything still works
# because craype-broadwell is pre-loaded upon login to Gaea c4
# (similarly for craype-haswell on Gaea c3)


# 
#Added in 
#module load fftw/3.3.4.8
#module load cray-netcdf
#module load cray-hdf5

#no change in 
pushd nwprod/lib/sorc/bacio; /bin/rm -f ../../libbacio*a;  make -f makefile4


# no change
pushd nwprod/lib/sorc/esmf_3_1_0rp5/esmf; sh compile_intel_unicos.sh


# Removed -xSSE4.2, 
# changed compiler from ifort to ftn (cray wrapper)
pushd nwprod/lib/sorc/sp; sh makelibsp.sh

#  Removed -xSSE4.2 in makefile_4, Removed -xHOST in makefile_d
pushd nwprod/lib/sorc/w3lib-2.0; /bin/rm -f ../../libw3*a; make -f makefile_4 clean; make -f makefile_4; make -f makefile_d clean; make -f makefile_d


#  Put -xSSE4.2 back in makefile.sh
pushd nwprod/lib/sorc/sigio; /bin/rm -f ../../libsigio*.a;   sh makefile.sh

#  Put -xSSE4.2 back in makefile.sh
pushd nwprod/lib/sorc/sfcio;  /bin/rm -f ../../libsfcio*.a; sh makefile.sh

# Removed -xHOST in Makefile, Makefile_d, 
pushd nwprod/lib/sorc/ip; make clean; make; /bin/cp -f libip_4.a ../../; make -f Makefile_d clean; make -f Makefile_d; /bin/cp -f libip_d.a ../..

# Removed -xHOST in makefile.sh, leave in for now
pushd nwprod/lib/sorc/nemsio; sh makefile.sh


#change pushd gfs/DA-REL-FY16
#to pushd gfs/global_fcst.fd.v14.0.1 
pushd gfs/global_fcst.fd.v14.0.1 ; make clean; sh makefile.sh

# Removed -xHost
# made several changes makefile.sh
gfs/global_fcst.fd.v14.0.1> diff makefile.sh makefile.sh.from_Jeff 
2,6c2,3
< #export LIBDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
< #export ESMFDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
< 
< export LIBDIR=../../nwprod/lib
< export ESMFDIR=../../nwprod/lib
---
> export LIBDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
> export ESMFDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib

# 11 Feb version
gfs/global_fcst.fd.v14.0.1> diff makefile.sh makefile.sh.from_Jeff 
2,6c2,3
< #export LIBDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
< #export ESMFDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
< 
< export LIBDIR=../../nwprod/lib
< export ESMFDIR=../../nwprod/lib
---
> export LIBDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
> export ESMFDIR=/lustre/f1/unswept/Jeffrey.S.Whitaker/nwprod/lib
33c30
< export OPTSB="-O3 -fp-model precise -convert big_endian"
---
> export OPTSB="-O3 -xHost -fp-model precise -convert big_endian"


# Removed -xHOST
pushd gfs/global_cycle.fd; /bin/rm -f *.o *.mod global_cycle*; make -f Makefile; make -f Makefilep

# still has -xHOST in Makefile, Makefile_p
pushd gfs/global_postgp.fd; /bin/rm -f global_postgp* *.o *.mod; make -f Makefile; make -f Makefile_p; /bin/cp -f global_postgp* ../../bin

#Put back -xSSE4.2 
pushd gfs/global_sfchdr.fd; /bin/rm -f global_sfchdr; make; /bin/cp -f global_sfchdr ../../bin

#Put back -xSSE4.2, changed -openmp to -qopenmp. 
pushd gfs/global_sighdr.fd; /bin/rm -f global_sighdr; make; /bin/cp -f global_sighdr ../../bin

#previously used Jeff's build of shtns, Changed to Gil's. changed -openmp to -qopenmp
# for some reason not finding the FFTW_DIR
#added newer module load fftw/3.3.4.8
pushd psop; make clean; make; /bin/cp -f *.x ../bin

#the Makefile.conf is what gets varied
#use Gil build of shtns
[Building SHTNS
20CRV3/shtns> diff Makefile Makefile.orig 
2,6c2
< # be sure to 
< #module swap PrgEnv-intel PrgEnv-gnu
< #module load fftw/3.3.4.8
< #
< PREFIX=/lustre/f1/unswept/Gilbert.P.Compo/20CRV3
---
> PREFIX=/lustre/f1/Jeffrey.S.Whitaker
10c6
< CFLAGS=-O2 -I$(PREFIX)/include -I$(FFTW_INC) -L$(PREFIX)/lib -L$(FFTW_DIR) -ffast-math -fomit-frame-pointer -std=gnu99
---
> CFLAGS=-O2 -I/lustre/f1/Jeffrey.S.Whitaker/include -I/opt/fftw/3.3.0.1/interlagos/include -L/lustre/f1/Jeffrey.S.Whitaker/lib -L/opt/fftw/3.3.0.1/interlagos/lib -ffast-math -fomit-frame-pointer -std=gnu99
]


pushd enkf/trunk/src; make clean; make

#Removed -xSSE4.2
pushd enkf/trunk/util/src; /bin/rm -f *.x *.o *.mod; make -f Makefile_gfs_nersc; /bin/cp -f *.x ../../../../bin

#no changes
pushd h5f_reader; make clean; make; /bin/cp -f h5ftotxt ../bin

#added in the build for hd5_reader_v4
pushd h5f_reader_v4; make clean; make; /bin/cp -f h5ftotxt_v4 ../bin

#Removed -xHost. 
#use Gil's build of shtns in lib
# changed -openmp to -qopenmp
pushd sig2grb; make clean; make; /bin/cp -f sig2grb ../bin

#Removed -xHOST
pushd nwprod/lib/sorc/gfsio; /bin/rm -f ../../libgfsio*a; make -f makefile_4

#Removed -xHOST in makefile_d
#makefile_d calls makefile
pushd nwprod/lib/sorc/landsfcutil; sh makefile_d

#no changes
pushd nwprod/lib/sorc/w3emc_v2.2.0/sorc; make clean; make ; /bin/cp -f w3emc/v2.2.0/libw3emc*a ../../../; /bin/rm -rf ../../../incmod/w3emc*; /bin/cp -R w3emc/v2.2.0/incmod/* ../../../incmod

#no changes
pushd nwprod/lib/sorc/w3nco_v2.0.6; sh makelibw3_nco.sh

#Removed -xHOST
pushd nwprod/lib/sorc/bacio_v2.0.1/src; sh makebacio_nersc.sh

#still uses -xHOST, leave in for now
pushd nwprod/lib/sorc/gfsio_v1.1.0; /bin/rm -f ../../libgfsio*a; make -f makefile_4

# changed -openmp to -qopenmp
pushd gfs/global_chgres.fd
sh makefile.sh





